import org.jetbrains.kotlin.konan.target.HostManager

project.ext {
    applicationName = 'ObjCInterop'
    commonSrcDirs = ['../../tools/benchmarks/shared/src', 'src/main/kotlin', '../shared/src/main/kotlin', '../../tools/kliopt']
    jvmSrcDirs = ['src/main/kotlin-jvm', '../shared/src/main/kotlin-jvm']
    nativeSrcDirs = ['src/main/kotlin-native', '../shared/src/main/kotlin-native']
    linkerOpts = ["-L$buildDir".toString(), "-lcomplexnumbers".toString()]
}

task compileLibrary {
    doFirst {
        mkdir buildDir.absolutePath
        execKonanClang(HostManager.host) {
            args "$projectDir/src/nativeInterop/cinterop/complexNumbers.m"
            args "-lobjc", '-fobjc-arc'
            args '-fPIC', '-shared', '-o', "$buildDir/libcomplexnumbers.dylib"
        }
    }
}

apply from: rootProject.file("${rootProject.rootDir}/performance/gradle/benchmark.gradle")
kotlin.targets.native.compilations.main.cinterops {
    classes {
        headers "$projectDir/src/nativeInterop/cinterop/complexNumbers.h"
    }
}

kotlin.targets.native.binaries.getExecutable("benchmark", "RELEASE").linkTask.dependsOn 'compileLibrary'
